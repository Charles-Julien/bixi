---
title: "Part 2: Linear regression models"
author: "Charles Julien, Chike Odenigbo, Atul Sharma, Gabriel Jobert"
date: "10/20/2023"
output: github_document
---

# Instructions

• Explore linear regression models for the response variables of interest, specifically, for trip lengths (duration) and revenue.

• Be sure that your analyses allow you to answer well formulated business / research questions that you wish to explore through these models. The goal is to use linear regression models to provide interesting and relevant insights from the data.

• Comment on findings and discuss the main takeaways from these analyses from a business
perspective. Be sure to provide relevant model outputs that support your discussion.

• Discuss any shortcomings or limitations of the analyses carried out.


# Business/Research questions

Examples : 

Are revenues significantly higher during the weekend?

Does the average trip duration varies from member to non-member?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning=FALSE, include = FALSE, echo=FALSE}
# Import (The fewer the better)

library(tidyverse)
library(ggplot2)
library(dplyr)
library(leaflet)
library(gridExtra)
```



```{r load_data, include=FALSE}
# Data loading

# Set working directory to file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
df_raw = read.csv("./../src/bixi10.csv")
df_station = read.csv("./../src/2021_stations.csv")
df_main = left_join(df_raw,df_station,by = c("station"="pk"))
head(df_main)

```
# Build some regression models, discuss their relevances and test assumptions

```{r echo=FALSE}
# Data preparation and feature engineering

# ? dd is it a categorical variable or ordinal or else?

df_main <- df_main %>% mutate(
              holiday = factor(holiday),
              mem = factor(mem),
              mm = factor(mm),
              station = factor(station),
              
              #Overwrite old wday?
              wday_ordered = factor(wday, levels = c("Monday", "Tuesday", "Wednesday",  "Thursday", "Friday", "Saturday", "Sunday"),ordered = TRUE),
              season = ifelse((mm %in% c(12,1,2)), 'Winter',
                       ifelse((mm %in% c(3,4,5)), 'Spring',
                       ifelse((mm %in% c(6,7,8)), 'Summer',
                       ifelse((mm %in% c(9,10,11)), 'Fall','No Season')))),
              
              rain_ind = factor(ifelse((rain != 0), 'Rain', 'NoRain')),
              
              # Compared to Parc Lafontaine 
              North_South = factor(ifelse(latitude>45.5271, 'North', 'South')),
              West_East = factor(ifelse(longitude>-73.5705, 'East', 'West')),
              
              # Beginning of month versus end of month
              PartOfMonth = factor(ifelse(dd>15, 'EOM', 'BOM')),
              
              rev_per_min = rev/dur,
              rev_per_trip = rev/n_tot,
             
              percent_AM = n_AM/n_tot,
              percent_PM = n_PM/n_tot,
              
              percent_AM_PM_delta = percent_AM - percent_PM,
              n_AM_PM_delta = n_AM - n_PM,
              
              am_pm_ind = ifelse(n_AM>=n_PM, 'AM','PM'),
              
              wknd_ind = factor(ifelse((wday %in% c("Sunday","Saturday")), 'Weekend'
                        ,'Weekday')),
                
              lomg_wknd_ind = factor(ifelse((wday %in% c("Sunday","Saturday")), 'Weekend'
                        ,ifelse((wday %in% c("Friday","Monday") & holiday=='1'),'Long Weekend','Weekday'))))
        
 
```



```{r}
# Chunk of code
```

```{r}
# Chunk of code
```

```{r}
# Chunk of code
```
# Research Question 1: How do seasonal factors impact trip durations and revenue for BIXI Montréal?

## Seasonal effect on trip duration
```{r seasonal_effect_trip_duration, echo=FALSE}
seasonal_effect_dur_model <- lm(dur ~ mm + temp*rain, data = df_main)
summary(seasonal_effect_dur_model)
```

### Findings and interpretation
From a business perspective, here's how you would interpret the output of the linear model:

**Model Overview**:
   The model is trying to observe the effect of month (`mm`), average temperature (`temp`), and rainfall (`rain`), along with the interaction between temperature and rainfall (`temp:rain`) on the trip duration (`dur`).

**Coefficients**:
   - **(Intercept)**: The base duration (when all other factors are 0) is approximately 129.8. However, since some factors (like temperature) cannot realistically be zero, we have to interpret this value with caution.
   
   - **Month (`mm`)**: Compared to April :
     - Trips in May (`mm5`) are on average 76.5 minutes longer.
     - Trips in June are approximately 91.8 minutes longer.
     - July sees the most significant increase with trips being about 117.7 minutes longer.
     - This trend decreases a bit in August with an increase of 101.2 minutes.
     - September trips are approximately 134.2 units minutes.
     - The effect diminishes in the later months with October seeing an increase of just 38.8 minutes and November just 18.8 minutes. However, note that the coefficient for November is not statistically significant (p-value > 0.05).
     
   - **Temperature (`temp`)**: For each additional degree Celsius in temperature, trip duration increases by around 4.16 minutes, all else being equal.
   
   - **Rainfall (`rain`)**: For each additional millimeter of rain, trip duration decreases by approximately 3.65 minutes. All else being equal. This might suggest that people tend to shorten their trips when it rains.
   
   - **Interaction Term (`temp:rain`)**: The interaction term is not statistically significant (p-value > 0.05), which means that the combined effect of temperature and rainfall on trip duration is not distinctly different from the sum of their individual effects.

**Model Fit**:
   - The **Multiple R-squared** value is 0.04691, which means that only about 4.69% of the variance in trip duration can be explained by the model. This is a pretty low value, suggesting that there may be other factors not considered in the model that influence trip duration.
      
   - The overall **F-statistic** has a very low p-value (p < 2.2e-16), indicating that the model is statistically significant and that at least one of the predictors has a relationship with trip duration.

**Business Implications**:

1. **Seasonality**: There's a clear seasonality in trip duration, with trips tending to be longer in the middle of the year (around July and September) compared to April. This could be due to various reasons like vacations, events, or other factors that influence trip behavior during these months.

2. **Weather**: Temperature has a positive relationship with trip duration, meaning people might take longer trips when it's warmer. On the other hand, rainfall tends to reduce trip length, which could be due to discomfort or safety concerns associated with traveling during rain.

3. **Model Improvements**: The low R-squared value indicates there are other factors not in the model affecting trip duration. Further research could help improve the predictive power of the model.

4. **Operational Decisions**: If a business relies on this data, it could optimize operations based on these insights. For example, they might expect longer trips and possibly more revenue during warmer, drier months. On rainy days, they might expect shorter trips and can adjust resources and strategies accordingly.

## Seasonal effect on revenue
```{r Seasonal_effect_revenue, echo=FALSE}
seasonal_effect_rev_model <- lm(rev ~ mm + temp + rain, data = df_main)
summary(seasonal_effect_rev_model)
```

**Objective of Analysis:**
This regression model is examining the impact of the month (`mm`), average daily temperature (`temp`), and total amount of rainfall (`rain`) on the revenue (`rev`) generated by trips leaving from a specified station.


**Business Interpretation:**

**Seasonality (Month):** 
   - The revenue seems to have a seasonal pattern. Compared to April (reference month), May (`mm5`) sees an increase in revenue by about 4.525. This increase is even more pronounced in the following months, with September (`mm9`) having the most substantial uplift of around 18.693$. 


**Temperature (`temp`):**
   - For every 1°C increase in temperature, the revenue increases by approximately 0.383 $, which is statistically significant (p-value: 0.0085).
   - This suggests that warmer days tend to generate more revenue.

**Rainfall (`rain`):**
   - For every additional mm of rainfall, the revenue decreases by approximately 0.493$, which is statistically significant (p-value: 7.13e-06).
   - This implies that rainfall negatively impacts the revenue.

**Model Fit:**
   - The Multiple R-squared value (0.04008) implies that around 4% of the variation in revenue is explained by the predictors in the model. While statistically significant (F-statistic p-value: < 2.2e-16), the model might benefit from considering additional predictors or non-linear effects to explain more of the variance in revenue.

**Recommendations for Business:**

1. **Operational Adjustments:** Given that revenue is higher in warmer months, consider optimizing operations for this period. This might involve higher staffing, more promotional activities, or ensuring optimal equipment availability.

2. **Rainy Day Strategies:** Since rainfall seems to negatively impact revenue, consider implementing strategies to mitigate this. For instance, promotional offers or special activities/events for rainy days might help attract customers.

## residual Analysis
```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns
seasonal_effect_rev_residual_qqplot = qqnorm(seasonal_effect_rev_model$residuals)
qqline(seasonal_effect_rev_model$residuals)
seasonal_effect_rev_residual_hist = hist(seasonal_effect_rev_model$residuals, main="Histogram of Residuals", xlab="Residuals")

seasonal_effect_dur_residual_qqplot = qqnorm(seasonal_effect_dur_model$residuals)
qqline(seasonal_effect_dur_model$residuals)
seasonal_effect_dur_residual_hist = hist(seasonal_effect_dur_model$residuals, main="Histogram of Residuals", xlab="Residuals")

#print(seasonal_effect_rev_residual_qqplot)
#print(seasonal_effect_rev_residual_hist)
#print(seasonal_effect_dur_residual_qqplot)
#print(seasonal_effect_dur_residual_hist)
```

1. **Histogram of Residuals**:
These histograms have a clear right-skew with a peak close to zero and a long tail towards the right. This suggests that most residuals are clustered around zero, but there are a few larger positive residuals. This is an indication that the normality assumption of the residuals may be violated.

2. **Normal Q-Q Plot**:
Most of the points are close to the line, which is a good sign. However, there's a clear deviation from the line on the top right corner, suggesting the presence of larger residuals that are not explained by a normal distribution. This reiterates the presence of the right skew seen in these histograms.

**Overall Interpretation**:
The residuals are not perfectly normal. They show a positive skewness, indicating there might be some observations with higher residuals (perhaps outliers or instances where the model systematically underpredicts). The deviation from normality might not be a problem because the sample is large enough.

# Research Question 2: How do daily and weekly patterns impact trip durations and revenue for BIXI Montréal?

## Effect of daily and weekly pattern on revenue (duration is the target variable in the lm)

```{r Time_pattern_revenue, echo=FALSE}
time_pattern_revenue_model <- lm(dur ~ dd + wday + holiday + n_AM + n_PM +n_AM*n_PM, data=df_main)
summary(time_pattern_revenue_model)
```

**Overall Model** 
(the above model is not the one described below)

- The model explains approximately 87.87% of the variation in revenue (`rev`) generated by trips taken by non-members, as indicated by the `Multiple R-squared` value.
- The model is statistically significant (F-statistic p-value is extremely small), suggesting that the predictors in the model collectively have an effect on revenue.

**Intercept**
- When all other variables are at their reference level (Friday during non holiday period), the average revenue is about $1.845.

**Coefficients**
- **dd (Day of the Month)**: The revenue increases by $0.01299 for each day later in the month, although this effect is not statistically significant (p = 0.54263).
  
- **wday (Weekday)**: Compared to the reference weekday (likely Friday since it's not listed) (We should probably show this in the correct order):
  - **Monday**: Revenue is lower by about $2.81 on average.
  - **Saturday**: Revenue is higher by about $1.93 on average.
  - **Sunday**: Revenue is higher by about $0.612 on average, but this is not statistically significant.
  - **Thursday**: Revenue is lower by about $2.63 on average.
  - **Tuesday**: Revenue is lower by about $4.33 on average.
  - **Wednesday**: Revenue is lower by about $3.13 on average.
  
  Most of these weekday effects are statistically significant, implying certain days of the week have distinctive revenue patterns for non-members.

- **Holiday**: On holidays, revenue is  on average higher by about $5.78 compared to non-holidays. This suggests that non-members are more likely to use the bike sharing service on holidays, generating higher revenue.

- **n_AM (Number of Trips in the Morning)**: For each additional trip in the morning, revenue increases by about $2.96 on average. This is significant, implying that more morning trips by non-members translate to more revenue.

- **n_PM (Number of Trips in the Afternoon)**: For each additional trip in the afternoon, revenue increases by about $5.50 on average. This indicates afternoon trips by non-members are particularly profitable.

- **Interaction Term (n_AM:n_PM)**: The positive coefficient (0.1036) suggests that as the number of trips in both the morning and afternoon increases, there's a rise in the overall revenue. However, this coefficient is too small to have a real impact.

**Business Implications**:

1. **Promotion and Marketing**: The company can offer special promotions for non-members on Saturdays and holidays when the revenue from non-members is typically higher. While members might provide a steady stream of revenue, there's significant revenue potential from non-members, especially on specific days and times. Marketing campaigns can target potential non-members to convert them or at least encourage them to ride more.

2. **Pricing Strategy**: Given the significant revenue differences across weekdays, dynamic pricing or special offers targeted towards non-members on lower revenue days (like Monday, Tuesday) could boost earnings.

3. **Operational Strategy**: Afternoon trips are highly lucrative. Ensuring bike availability and visibility during afternoons can drive higher non-member usage.

4. **Further Investigation**: While this analysis gives insights into non-member behavior, comparing it with member behavior would provide a more comprehensive view and allow for better-targeted strategies.


## Effect of daily and weekly pattern on trip duration
```{r Time_pattern_trip_duration, echo=FALSE}
time_pattern_dur_model <- lm(dur ~ dd + wday + holiday + n_AM + n_PM +n_AM*n_PM, data=df_main)
summary(time_pattern_dur_model)
```

**Overall Model**
- The model explains approximately 87.27% of the variation in the trip duration.
- The model is statistically significant (F-statistic p-value is extremely small), suggesting that the predictors in the model collectively have an effect on the trip duration.

**Intercept**
- When all other variables are at their reference level (Friday not on a holiday), the predicted trip duration is about 30.77 minutes on average.

**Coefficients**
- **dd (Day of the Month)**: For each day later in the month, the trip duration decreases by about 0.0688 minutes on average, although this effect is not statistically significant (p = 0.58548).
  
- **wday (Weekday)**: Compared to the Friday:
  - **Monday**: Trips are shorter by about 27.97 minutes on average.
  - **Saturday**: Trips are longer by about 29.10 minutes on average.
  - **Sunday**: Trips are longer by about 11.20 minutes on average.
  - **Thursday**: Trips are shorter by about 11.92 minutes on average.
  - **Tuesday**: Trips are shorter by about 29.25 minutes on average.
  - **Wednesday**: Trips are shorter by about 18.29 minutes on average.
  - The coefficients for all these weekdays are statistically significant.

- **Holiday**: On holidays, trips are  on average longer by about 56.24 minutes compared to non-holidays. This effect is statistically significant, suggesting holidays might lead to longer leisure trips or normal trips to different destinations than workdays.

- **n_AM (Number of Trips in the Morning)**: For each additional trip in the morning, the trip duration increases by about 8.51 minutes on average. This is statistically significant, implying that when there are more trips in the morning, they tend to be longer.

- **n_PM (Number of Trips in the Afternoon)**: For each additional trip in the afternoon, the trip duration increases by about 19.12 minutes on average. This is statistically significant and implies that afternoon trips tend to be longer.

- **Interaction Term (n_AM:n_PM)**: The negative coefficient (-0.0920) suggests that as the number of trips in both the morning and afternoon increases, there's a slight decrease in the overall trip duration. However, given the fact that the coefficient is really weak, the impact will be almost imperceptible.

**Business Implications**:

1. **Promotion and Marketing**: If the bike sharing company wants to run promotions, they might consider targeting days when users take longer trips, like Saturdays or holidays.

2. **Resource Allocation**: Understanding that afternoon trips are longer might help in resource allocation, e.g., ensuring bikes are available and well-maintained for the afternoon surge.

3. **Pricing Strategy**: The company can consider dynamic pricing based on the day of the week or if it's a holiday, adjusting prices for longer trip durations on certain days.

4. **Operational Strategy**: The interaction term suggests that on particularly busy days (both morning and afternoon), the average trip duration decreases slightly. This could be due to increased congestion or users taking shorter trips when they notice many bikes are in use.


## residual Analysis
```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns
time_pattern_revenue_residual_qqplot = qqnorm(time_pattern_revenue_model$residuals)
qqline(time_pattern_revenue_model$residuals)
time_pattern_revenue_residual_hist = hist(time_pattern_revenue_model$residuals, main="Histogram of Residuals", xlab="Residuals")

time_pattern_dur_residual_qqplot = qqnorm(time_pattern_dur_model$residuals)
qqline(time_pattern_dur_model$residuals)
time_pattern_dur_residual_hist = hist(time_pattern_dur_model$residuals, main="Histogram of Residuals", xlab="Residuals")

#print(seasonal_effect_rev_residual_qqplot)
#print(seasonal_effect_rev_residual_hist)
#print(seasonal_effect_dur_residual_qqplot)
#print(seasonal_effect_dur_residual_hist)
```

**Histogram of Residuals**:
   - At first glance, the residuals appear to be roughly normally distributed as the majority of them are centered around zero.

**Normal Q-Q Plot**:
   - If the residuals were perfectly normally distributed, the points would lie exactly on the diagonal line.
   - For the most part, the points closely follow the lines, suggesting that the residuals are approximately normally distributed.
   - Nevertheless, there's a deviation from the line at both the lower and upper ends. This implies that there are some residuals that are more extreme than what we'd expect under a perfect normal distribution, indicating the presence of outliers or potentially heavy tails in the residual distribution.

**Implications**:

- The residuals being approximately centered around zero and their near-normal distribution suggest that the model's assumption of linearity and constant variance (homoscedasticity) are likely met. This is good for the validity of the regression analysis.
  
- The presence of outliers or extreme values, as indicated by the tails in the histogram and the deviations in the Q-Q plot, might influence the regression results. These influential observations could distort the regression coefficients and reduce the precision of predictions.

- The existence of outliers suggests that it might be beneficial to investigate these specific data points further to determine if they're genuine observations or potential errors. If they're genuine, one might consider robust regression techniques or transformations to minimize their influence.


# Research Question 3: What variables impact the average bixi trip duration?
The idea is to identify the driving factors of a bixi trip length when we control for most of the variables. 

Average trip duration for members is a good proxy for the revenue they would bring if they were non-members.

Variables that make business sense to include:

From our seasonality analysis we identified:
- Season (season)
- Temperature in degrees celcius (temp)
- Rainfall in mm (rain)

From our daily and weekly pattern analysis we identified:
- Part of the week i.e. weekend or weekday (wknd_ind)
- If it is a holiday (holiday)

Some other variables that are interesting:
- If the user is a member (mem)
- Location of the bixi station compared to Parc Lafontaine (North_South) and (West_East)
- Proportion of trips in the morning versus the whole day (percent_AM)
- total number of trips (n_tot)

Interactions:
In our EDA we observed a different week day usage of the member and non members, thus an interaction term between members and day of week would be interesting. (wday*mem).

```{r , echo=FALSE}
model_AvgDur <- lm(avg ~ season + temp + rain + wknd_ind*mem + holiday  + North_South + West_East + n_tot + percent_AM, data = df_main)
summary(model_AvgDur)
```
**Overall Model**
- The model explains approximately 12.52% of the variation in the average trip duration.
 which means that other factors are also at play and not included in the model.

**Intercept**
- The interpretation of the intercept does not make sense in this case since the number of trips would have to be zero. 

**Coefficients**
- **Season**: The reference level is fall. We can see that on average trip duration during spring and summer are respectively 2.33 and 0.38 minutes longer than in fall holding everything else constant. 

- **Temperature**: The coefficient of temperature is 0.14 which means that an increase in temperature of 1 degree celcius corresponds to an increase of average trip duration of 0.14 minutes on average holding all else constant.

- **Rainfall**: The coefficient for rain is -0.12 which means that an increase in rainfall of 1 mm corresponds to a decrease of average trip duration of 0.12 minutes on average holding all else constant.

- **Effect of Weekend Indicator and membership**: Since there exists an interaction between both variables, it is no longer possible to interpret one without the other. This implies that the relation between average trip duration and membership is different depending on the moment of the week. The opposite is also true, the relation between average trip duration and the moment of the week is different depending on the membership status.

 - Weekend indicator's coefficient 2.638923 is the average difference between average trip duration during weekend and weekday for non-members. In other words, for non-members, average trip duration is higher on average than for members holding all else constant.
 
- Membership's coefficient -0.385385 is the average difference between average trip duration for members and non-members for weekdays. In other words, during weekdays, the average trip duration is shorter on average for members than for non-members holding all else constant.

- Interaction term's coefficient -1.868383 is ... 

- **Holiday**: The coefficient for holiday is 1.069557 which means that during holidays  average trip duration is 1.069 minutes higher on average than during non-holidays, holding all else constant.

- **North_South and West_East**: Their coefficients are 0.35 and -0.23 which means that on average the average trip duration for trips starting at a station South of Parc Lafontaine or West is 0.35 and -0.23 minutes different from their counter parts respectively, holding all else constant.


- **Total number of trips**: The coefficient is -0.055315 which means that on average as number of trips increase, the average trip length in minutes decreases, holding all else constant.

- **Percent AM**: The magnitude of the coefficient -2.351044 is less important than its sign for our interpretation. What it means is that as the proportion of trips in the morning increases, the average trip duration generally decreases when holding all else constant. This hints that trips in the morning might be shorter on average than trip in the afternoon, hence bring in less revenue.


**Business Implications**:

1. **Promotion and Marketing**: For the same temperature, average trip length tends to be the longest in spring.  This indicates that users are eager to use bikes after winter. This insight could be used for promotion purposes.

2. **Resource Allocation**: Expect longer trips when it is hot and non-rainy outside. Even more if it is a weekend or holiday. Also, bikes tend to be borrowed longer during the afternoon than in the morning. Stations south of Parc Lafontaine have on average longer trip duration, which may suggests that stations are further from one another. There might be some space for additional stations.

3. **Pricing Strategy**: The usage that is associated with the longest trip length based on our interaction term is for non-members during the weekend. Charging a heftier price for these people at that time may increase profit margins significantly.

4. **Operational Strategy**: It is important to keep in mind the tradeoff between the number of trips and the average trip length. Indeed, as the number of trips increase for a given day, the average trip length decreases. This may suggest that the additional trips during those days are short haul.


### Verificaiton of Normality of Residuals
```{r, echo=FALSE}
res = hist(model_AvgDur$residuals, main="Histogram of Residuals", xlab="Residuals")

```

### Verificaiton of Heteroscedasticity
```{r , echo=FALSE}
residuals_df <- data.frame(df_main, residuals = residuals(model_AvgDur))

p1 <- ggplot(data = residuals_df, aes(x = temp, y = residuals)) +
  geom_point() +
  labs(x = "temp", y = "Residuals")

p2 <- ggplot(data = residuals_df, aes(x = rain, y = residuals)) +
  geom_point() +
  labs(x = "rain", y = "Residuals")

p3 <- ggplot(data = residuals_df, aes(x = n_tot, y = residuals)) +
  geom_point() +
  labs(x = "n_tot", y = "Residuals")

p4 <- ggplot(data = residuals_df, aes(x = percent_AM, y = residuals)) +
  geom_point() +
  labs(x = "percent_AM", y = "Residuals")

grid.arrange(p1, p2, p3, p4, ncol=2)

```

blablabla

# Limitations and shortcomings

blablabla

# Contribution

Charles Julien :

Gabriel Jobert :

Chike Odenigbo: 

Atul Sharma: 