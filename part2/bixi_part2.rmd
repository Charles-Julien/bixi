---
title: "Part 2: Linear regression models"
author: "Charles Julien, Chike Odenigbo, Atul Sharma, Gabriel Jobert"
date: "10/20/2023"
output: github_document
---

# Instructions

• Explore linear regression models for the response variables of interest, specifically, for trip lengths (duration) and revenue.

• Be sure that your analyses allow you to answer well formulated business / research questions that you wish to explore through these models. The goal is to use linear regression models to provide interesting and relevant insights from the data.

• Comment on findings and discuss the main takeaways from these analyses from a business
perspective. Be sure to provide relevant model outputs that support your discussion.

• Discuss any shortcomings or limitations of the analyses carried out.


# Business/Research questions

Examples : 

Are revenues significantly higher during the weekend?

Does the average trip duration varies from member to non-member?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning=FALSE, include = FALSE, echo=FALSE}
# Import (The fewer the better)

library(tidyverse)
library(ggplot2)
library(dplyr)
library(leaflet)
```



```{r load_data, include=FALSE}
# Data loading

# Set working directory to file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
df_raw = read.csv("./../src/bixi10.csv")
df_station = read.csv("./../src/2021_stations.csv")
df_main = left_join(df_raw,df_station,by = c("station"="pk"))
head(df_main)

```
# Build some regression models, discuss their relevances and test assumptions

```{r echo=FALSE}
# Data preparation and feature engineering

# ? dd is it a categorical variable or ordinal or else?

# Correlation between rev and dur is 0.994467, should we do something like a merge variable ?

df_main <- df_main %>% mutate(
              holiday = factor(holiday),
              mem = factor(mem),
              mm = factor(mm),
              station = factor(station),
              
              #Overwrite old wday?
              wday_ordered = factor(wday, levels = c("Monday", "Tuesday", "Wednesday",  "Thursday", "Friday", "Saturday", "Sunday"),ordered = TRUE),
              season = ifelse((mm %in% c(12,1,2)), 'Winter',
                       ifelse((mm %in% c(3,4,5)), 'Spring',
                       ifelse((mm %in% c(6,7,8)), 'Summer',
                       ifelse((mm %in% c(9,10,11)), 'Fall','No Season')))),
              
              rain_ind = factor(ifelse((rain != 0), 'Rain', 'NoRain')),
              
              rev_per_min = rev/dur,
              rev_per_trip = rev/n_tot,
             
              percent_AM = n_AM/n_tot,
              percent_PM = n_PM/n_tot,
              
              percent_AM_PM_delta = percent_AM - percent_PM,
              n_AM_PM_delta = n_AM - n_PM,
              
              am_pm_ind = ifelse(n_AM>=n_PM, 'AM','PM'),
                
              wknd_ind = ifelse((wday %in% c("Sunday","Saturday")), 'Weekend'
                        ,ifelse((wday %in% c("Friday","Monday") & holiday=='1'),'Long Weekend','Weekday')))
        
 
```


# Research Question 1: How do seasonal factors impact trip durations and revenue for BIXI Montréal?

## Seasonal effect on trip duration
```{r seasonal_effect_trip_duration, echo=FALSE}
seasonal_effect_dur_model <- lm(dur ~ mm + temp*rain, data = df_main)
summary(seasonal_effect_dur_model)
```

### Findings and interpretation
From a business perspective, here's how you would interpret the output of the linear model:

**Model Overview**:
   The model is trying to observe the effect of month (`mm`), average temperature (`temp`), and rainfall (`rain`), along with the interaction between temperature and rainfall (`temp:rain`) on the trip duration (`dur`).

**Coefficients**:
   - **(Intercept)**: The base duration (when all other factors are 0) is approximately 129.8. However, since some factors (like temperature) cannot realistically be zero, we have to interpret this value with caution.
   
   - **Month (`mm`)**: Compared to April :
     - Trips in May (`mm5`) are on average 76.5 minutes longer.
     - Trips in June are approximately 91.8 minutes longer.
     - July sees the most significant increase with trips being about 117.7 minutes longer. (what about september?)
     - This trend decreases a bit in August with an increase of 101.2 minutes.
     - September trips are approximately 134.2 units minutes. (more than september)
     - The effect diminishes in the later months with October seeing an increase of just 38.8 minutes and November just 18.8 minutes. However, note that the coefficient for November is not statistically significant (p-value > 0.05). Thus the effect of seasonality is similar to april.
     
   - **Temperature (`temp`)**: For each additional degree Celsius in temperature, trip duration increases by around 4.16 minutes on average, all else being equal.
   
   - **Rainfall (`rain`)**: For each additional millimeter of rain,average trip duration decreases by approximately 3.65 minutes. All else being equal. This might suggest that people tend to shorten their trips when it rains.
   
   - **Interaction Term (`temp:rain`)**: The interaction term is not statistically significant (p-value > 0.05), which means that the combined effect of temperature and rainfall on trip duration is not distinctly different from the sum of their individual effects.

**Model Fit**:
   - The **Multiple R-squared** value is 0.04691, which means that only about 4.69% of the variance in trip duration can be explained by the model. This is a pretty low value, suggesting that there may be other factors not considered in the model that influence trip duration.
      
   - The overall **F-statistic** has a very low p-value (p < 2.2e-16), indicating that the model is statistically significant and that at least one of the predictors has a relationship with trip duration.

**Business Implications**:

1. **Seasonality**: There's a clear seasonality in trip duration, with trips tending to be longer in the middle of the year (around July and September) compared to April. This could be due to various reasons like vacations, events, or other factors that influence trip behavior during these months.

2. **Weather**: Temperature has a positive relationship with trip duration, meaning people might take longer trips when it's warmer. On the other hand, rainfall tends to reduce trip length, which could be due to discomfort or safety concerns associated with traveling during rain.

3. **Model Improvements**: The low R-squared value indicates there are other factors not in the model affecting trip duration. Further research could help improve the predictive power of the model.

4. **Operational Decisions**: If a business relies on this data, it could optimize operations based on these insights. For example, they might expect longer trips and possibly more revenue during warmer, drier months. On rainy days, they might expect shorter trips and can adjust resources and strategies accordingly.

## Seasonal effect on revenue
```{r Seasonal_effect_revenue, echo=FALSE}
seasonal_effect_rev_model <- lm(rev ~ mm + temp + rain, data = df_main)
summary(seasonal_effect_rev_model)
```

**Objective of Analysis:**
This regression model is examining the impact of the month (`mm`), average daily temperature (`temp`), and total amount of rainfall (`rain`) on the revenue (`rev`) generated by trips leaving from a specified station.


**Business Interpretation:**

**Seasonality (Month):** 
   - The revenue seems to have a seasonal pattern. Compared to April (reference month), May (`mm5`) sees an increase in revenue by about 4.525$. This increase is even more pronounced in the following months, with September (`mm9`) having the most substantial uplift of around 18.693$. 


**Temperature (`temp`):**
   - For every 1°C increase in temperature, the revenue increases by approximately 0.383 $, which is statistically significant (p-value: 0.0085).
   - This suggests that warmer days tend to generate more revenue.

**Rainfall (`rain`):**
   - For every additional mm of rainfall, the revenue decreases by approximately 0.493$, which is statistically significant (p-value: 7.13e-06).
   - This implies that rainfall negatively impacts the revenue.

**Model Fit:**
   - The Multiple R-squared value (0.04008) implies that around 4% of the variation in revenue is explained by the predictors in the model. While statistically significant (F-statistic p-value: < 2.2e-16), the model might benefit from considering additional predictors or non-linear effects to explain more of the variance in revenue.

**Recommendations for Business:**

1. **Operational Adjustments:** Given that revenue is higher in warmer months, consider optimizing operations for this period. This might involve higher staffing, more promotional activities, or ensuring optimal equipment availability.

2. **Rainy Day Strategies:** Since rainfall seems to negatively impact revenue, consider implementing strategies to mitigate this. For instance, promotional offers or special activities/events for rainy days might help attract customers.


## residual Analysis
```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns
seasonal_effect_rev_residual_qqplot = qqnorm(seasonal_effect_rev_model$residuals)
qqline(seasonal_effect_rev_model$residuals)
seasonal_effect_rev_residual_hist = hist(seasonal_effect_rev_model$residuals, main="Histogram of Residuals", xlab="Residuals")

seasonal_effect_dur_residual_qqplot = qqnorm(seasonal_effect_dur_model$residuals)
qqline(seasonal_effect_dur_model$residuals)
seasonal_effect_dur_residual_hist = hist(seasonal_effect_dur_model$residuals, main="Histogram of Residuals", xlab="Residuals")

print(seasonal_effect_rev_residual_qqplot)
print(seasonal_effect_rev_residual_hist)
print(seasonal_effect_dur_residual_qqplot)
print(seasonal_effect_dur_residual_hist)
```


1. **Histogram of Residuals**:
These histograms have a clear right-skew with a peak close to zero and a long tail towards the right. This suggests that most residuals are clustered around zero, but there are a few larger positive residuals. This is an indication that the normality assumption of the residuals may be violated.

2. **Normal Q-Q Plot**:
Most of the points are close to the line, which is a good sign. However, there's a clear deviation from the line on the top right corner, suggesting the presence of larger residuals that are not explained by a normal distribution. This reiterates the presence of the right skew seen in these histograms.

**Overall Interpretation**:
The residuals are not perfectly normal. They show a positive skewness, indicating there might be some observations with higher residuals (perhaps outliers or instances where the model systematically underpredicts). The deviation from normality might not be a problem because the sample is large enough.

# Research Question 2: How do daily and weekly patterns impact trip durations and revenue for BIXI Montréal?

## Effect of daily and weekly pattern on revenue (duration is the target variable in the lm)

```{r Time_pattern_revenue, echo=FALSE}
time_pattern_revenue_model <- lm(dur ~ dd + wday + holiday + n_AM + n_PM +n_AM*n_PM, data=df_main)
summary(time_pattern_revenue_model)
```

**Overall Model** 
(the above model is not the one described below)

- The model explains approximately 87.87% of the variation in revenue (`rev`) generated by trips taken by non-members, as indicated by the `Multiple R-squared` value.
- The model is statistically significant (F-statistic p-value is extremely small), suggesting that the predictors in the model collectively have an effect on revenue.

**Intercept**
- When all other variables are at their reference level (Friday during non holiday period), the average revenue is about $1.845.

**Coefficients**
- **dd (Day of the Month)**: The revenue increases by $0.01299 for each day later in the month, although this effect is not statistically significant (p = 0.54263).
  
- **wday (Weekday)**: Compared to the reference weekday (likely Friday since it's not listed) (We should probably show this in the correct order):
  - **Monday**: Revenue is lower by about $2.81 on average.
  - **Saturday**: Revenue is higher by about $1.93 on average.
  - **Sunday**: Revenue is higher by about $0.612 on average, but this is not statistically significant.
  - **Thursday**: Revenue is lower by about $2.63 on average.
  - **Tuesday**: Revenue is lower by about $4.33 on average.
  - **Wednesday**: Revenue is lower by about $3.13 on average.
  
  Most of these weekday effects are statistically significant, implying certain days of the week have distinctive revenue patterns for non-members.

- **Holiday**: On holidays, revenue is  on average higher by about $5.78 compared to non-holidays. This suggests that non-members are more likely to use the bike sharing service on holidays, generating higher revenue.

- **n_AM (Number of Trips in the Morning)**: For each additional trip in the morning, revenue increases by about $2.96 on average. This is significant, implying that more morning trips by non-members translate to more revenue.

- **n_PM (Number of Trips in the Afternoon)**: For each additional trip in the afternoon, revenue increases by about $5.50 on average. This indicates afternoon trips by non-members are particularly profitable.

- **Interaction Term (n_AM:n_PM)**: The positive coefficient (0.1036) suggests that as the number of trips in both the morning and afternoon increases, there's a rise in the overall revenue. However, this coefficient is too small to have a real impact.

**Business Implications**:

1. **Promotion and Marketing**: The company can offer special promotions for non-members on Saturdays and holidays when the revenue from non-members is typically higher. While members might provide a steady stream of revenue, there's significant revenue potential from non-members, especially on specific days and times. Marketing campaigns can target potential non-members to convert them or at least encourage them to ride more.

2. **Pricing Strategy**: Given the significant revenue differences across weekdays, dynamic pricing or special offers targeted towards non-members on lower revenue days (like Monday, Tuesday) could boost earnings.

3. **Operational Strategy**: Afternoon trips are highly lucrative. Ensuring bike availability and visibility during afternoons can drive higher non-member usage.

4. **Further Investigation**: While this analysis gives insights into non-member behavior, comparing it with member behavior would provide a more comprehensive view and allow for better-targeted strategies.


## Effect of daily and weekly pattern on trip duration
```{r Time_pattern_trip_duration, echo=FALSE}
time_pattern_dur_model <- lm(dur ~ dd + wday + holiday + n_AM + n_PM +n_AM*n_PM, data=df_main)
summary(time_pattern_dur_model)
```

**Overall Model**
- The model explains approximately 87.27% of the variation in the trip duration.
- The model is statistically significant (F-statistic p-value is extremely small), suggesting that the predictors in the model collectively have an effect on the trip duration.

**Intercept**
- When all other variables are at their reference level (Friday not on a holiday), the predicted trip duration is about 30.77 minutes on average.

**Coefficients**
- **dd (Day of the Month)**: For each day later in the month, the trip duration decreases by about 0.0688 minutes on average, although this effect is not statistically significant (p = 0.58548).
  
- **wday (Weekday)**: Compared to the Friday:
  - **Monday**: Trips are shorter by about 27.97 minutes on average.
  - **Saturday**: Trips are longer by about 29.10 minutes on average.
  - **Sunday**: Trips are longer by about 11.20 minutes on average.
  - **Thursday**: Trips are shorter by about 11.92 minutes on average.
  - **Tuesday**: Trips are shorter by about 29.25 minutes on average.
  - **Wednesday**: Trips are shorter by about 18.29 minutes on average.
  - The coefficients for all these weekdays are statistically significant.

- **Holiday**: On holidays, trips are  on average longer by about 56.24 minutes compared to non-holidays. This effect is statistically significant, suggesting holidays might lead to longer leisure trips or normal trips to different destinations than workdays.

- **n_AM (Number of Trips in the Morning)**: For each additional trip in the morning, the trip duration increases by about 8.51 minutes on average. This is statistically significant, implying that when there are more trips in the morning, they tend to be longer.

- **n_PM (Number of Trips in the Afternoon)**: For each additional trip in the afternoon, the trip duration increases by about 19.12 minutes on average. This is statistically significant and implies that afternoon trips tend to be longer.

- **Interaction Term (n_AM:n_PM)**: The negative coefficient (-0.0920) suggests that as the number of trips in both the morning and afternoon increases, there's a slight decrease in the overall trip duration. However, given the fact that the coefficient is really weak, the impact will be almost imperceptible.

**Business Implications**:

1. **Promotion and Marketing**: If the bike sharing company wants to run promotions, they might consider targeting days when users take longer trips, like Saturdays or holidays.

2. **Resource Allocation**: Understanding that afternoon trips are longer might help in resource allocation, e.g., ensuring bikes are available and well-maintained for the afternoon surge.

3. **Pricing Strategy**: The company can consider dynamic pricing based on the day of the week or if it's a holiday, adjusting prices for longer trip durations on certain days.

4. **Operational Strategy**: The interaction term suggests that on particularly busy days (both morning and afternoon), the average trip duration decreases slightly. This could be due to increased congestion or users taking shorter trips when they notice many bikes are in use.


## residual Analysis
```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns
time_pattern_revenue_residual_qqplot = qqnorm(time_pattern_revenue_model$residuals)
qqline(time_pattern_revenue_model$residuals)
time_pattern_revenue_residual_hist = hist(time_pattern_revenue_model$residuals, main="Histogram of Residuals", xlab="Residuals")

time_pattern_dur_residual_qqplot = qqnorm(time_pattern_dur_model$residuals)
qqline(time_pattern_dur_model$residuals)
time_pattern_dur_residual_hist = hist(time_pattern_dur_model$residuals, main="Histogram of Residuals", xlab="Residuals")

print(seasonal_effect_rev_residual_qqplot)
print(seasonal_effect_rev_residual_hist)
print(seasonal_effect_dur_residual_qqplot)
print(seasonal_effect_dur_residual_hist)
```

**Histogram of Residuals**:
   - At first glance, the residuals appear to be roughly normally distributed as the majority of them are centered around zero.

**Normal Q-Q Plot**:
   - If the residuals were perfectly normally distributed, the points would lie exactly on the diagonal line.
   - For the most part, the points closely follow the lines, suggesting that the residuals are approximately normally distributed.
   - Nevertheless, there's a deviation from the line at both the lower and upper ends. This implies that there are some residuals that are more extreme than what we'd expect under a perfect normal distribution, indicating the presence of outliers or potentially heavy tails in the residual distribution.

**Implications**:

- The residuals being approximately centered around zero and their near-normal distribution suggest that the model's assumption of linearity and constant variance (homoscedasticity) are likely met. This is good for the validity of the regression analysis.
  
- The presence of outliers or extreme values, as indicated by the tails in the histogram and the deviations in the Q-Q plot, might influence the regression results. These influential observations could distort the regression coefficients and reduce the precision of predictions.

- The existence of outliers suggests that it might be beneficial to investigate these specific data points further to determine if they're genuine observations or potential errors. If they're genuine, one might consider robust regression techniques or transformations to minimize their influence.


# Discuss the findings (business perspective)

blablabla

# Limitations and shortcomings

- Causation vs. Correlation: The regression model captures relationships but does not establish causation.
- Data Exclusions: The data only considers trips under 60 minutes, which might exclude a segment of users who use BIXI for longer journeys.
- Other External Factors: Events, road conditions, or public transportation disruptions can affect BIXI usage but are not captured in the dataset.

# Contribution

Charles Julien :

Gabriel Jobert :

Chike Odenigbo: 

Atul Sharma: 
