---
title: "Part 2: Linear regression models"
author: "Charles Julien, Chike Odenigbo, Atul Sharma, Gabriel Jobert"
date: "10/20/2023"
output:
  pdf_document:
    toc: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning=FALSE, include = FALSE, echo=FALSE}
# Import (The fewer the better)

library(tidyverse)
library(ggplot2)
library(dplyr)
library(leaflet)
library(gridExtra)
library(broom)
library(stats)
library(car)
```

```{r load_data, include=FALSE}
# Data loading

# Set working directory to file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
df_raw = read.csv("./../src/bixi10.csv")
df_station = read.csv("./../src/2021_stations.csv")
df_main = left_join(df_raw,df_station,by = c("station"="pk"))
head(df_main)

```

```{r echo=FALSE}
# Data preparation and feature engineering

# Note: Correlation between rev and dur is very high 0.994467

df_main <- df_main %>% mutate(
              holiday = factor(holiday),
              mem = factor(mem),
              mm = factor(mm),
              station = factor(station),
              
              wday_ordered = factor(wday, levels = c("Monday", "Tuesday", "Wednesday",  "Thursday", "Friday", "Saturday", "Sunday"),ordered = TRUE),
              season = ifelse((mm %in% c(12,1,2)), 'Winter',
                       ifelse((mm %in% c(3,4,5)), 'Spring',
                       ifelse((mm %in% c(6,7,8)), 'Summer',
                       ifelse((mm %in% c(9,10,11)), 'Fall','No Season')))),
              
              rain_ind = factor(ifelse((rain != 0), 'Rain', 'NoRain')),
              
              # Compared to Parc Lafontaine 
              North_South = factor(ifelse(latitude>45.5271, 'North', 'South')),
              West_East = factor(ifelse(longitude>-73.5705, 'East', 'West')),
              
              # Beginning of month versus end of month
              PartOfMonth = factor(ifelse(dd>15, 'EOM', 'BOM')),
              
              Metro_ind = factor(ifelse(grepl("Métro", name),1,0)),
              
              lntot = log(n_tot),
              
              rev_per_min = rev/dur,
              rev_per_trip = rev/n_tot,
             
              percent_AM = n_AM/n_tot,
              percent_PM = n_PM/n_tot,
              
              percent_AM_PM_delta = percent_AM - percent_PM,
              n_AM_PM_delta = n_AM - n_PM,
              
              am_pm_ind = ifelse(n_AM>=n_PM, 'AM','PM'),
              
              wknd_ind = factor(ifelse((wday %in% c("Sunday","Saturday")), 'Weekend'
                        ,'Weekday')),
                
              long_wknd_ind = factor(ifelse((wday %in% c("Sunday","Saturday")), 'Weekend'
                        ,ifelse((wday %in% c("Friday","Monday") & holiday=='1'),'Long Weekend','Weekday'))),
        
              year = 2021 ,
              
              date = as.Date(paste(year,mm,dd,sep="/")),
              
              week_num = as.numeric(strftime(date, format = "%V")))
 
```

# Introduction
**Unlocking the Wheels of Urban Mobility: A Data-Driven Analysis of BIXI**

In the fast-paced, ever-evolving landscape of urban transportation, the
quest to create efficient and sustainable solutions for city dwellers
continues to be a paramount concern. Amidst the diverse array of options
that have emerged in recent years, the BIXI public cycling service
stands as a beacon of sustainable urban mobility. Offering an
accessible, convenient, and eco-friendly mode of transportation, BIXI
has transformed the way people navigate and experience cities.

As part of our commitment to understanding and improving urban
transportation systems, our consultant team has embarked on an in-depth
exploration of BIXI's operational data. The objective of this report is
to provide a comprehensive analysis of the data collected from the BIXI
service. By leveraging statistical and data analysis techniques, we aim
to uncover valuable insights into the usage patterns, financial
dynamics, and various factors affecting BIXI's performance. Our study
covers an extensive range of factors, including ridership trends,
environmental conditions, user classifications, and more.

One of the central questions addressed in this report is whether revenue
generated by the BIXI service and trip duration significantly varies
during weekends compared to weekdays. we also delve into the other
factors affecting the duration of trips and the revenue generated by
non-members. Our methodology combines data analysis, data visualization,
and statistical modeling, with a primary focus on using R, a powerful
statistical tool, to extract meaningful information from the BIXI
dataset.

By analyzing this data, we aim to assist BIXI in making data-informed
decisions to enhance the efficiency and quality of their services,
ultimately contributing to the betterment of urban living. We believe
that the findings and recommendations presented in this report will not
only provide valuable insights to BIXI but also serve as a valuable
reference for urban planners, researchers, and policymakers who are
dedicated to creating more sustainable, convenient, and enjoyable urban
environments.

The following sections of the report will delve into the specifics of
our data analysis, share our findings, and provide recommendations based
on the insights gathered during this project.

# Business/Research questions
(keep only the ones that were answered)

Do members travel more than non-members during the rain periods? (Shows
commitment of members)

Do members travel more during weekends than non-members? (Shows
commitment of members)

Do stations more commonly traveled in the mornings have lower duration
per trip than stations more commonly traveled in the afternoon?

Do members prefer to travel in the morning as opposed to non-members?
(Members are work commuters, non-members are recreational)

Do members prefer to travel in the morning as opposed to non-members?
Also including the weekend vs weekday.

Are revenues significantly higher during the weekend?

Does the average trip duration varies from member to non-member?

How does weather interact with weekday in determining the number of
trips?



# Pre-processing
## Outlier detection

```{r}
model <- lm(n_AM_PM_delta ~ long_wknd_ind + season + rain_ind + mem, data = df_main) # Goal is to look at stations more used in the mornings than afternoons
summary(model)
```

```{r}
model.diag.metrics <- augment(model)
head(model.diag.metrics)
```

```{r}
# OUTLIERS  WITH COOKS DISTANCE
model.diag.metrics %>%
  top_n(3, wt = .cooksd)
```

# Research Question 1: How do seasonal factors impact trip revenue for BIXI Montréal?

## Model

```{r Seasonal_effect_revenue, echo=FALSE}
seasonal_effect_rev_model <- lm(rev ~ mm + temp + rain, data = df_main)
summary(seasonal_effect_rev_model)
```

## Objective

**Objective of Analysis:** This regression model is examining the impact
of the month (`mm`), average daily temperature (`temp`), and total
amount of rainfall (`rain`) on the revenue (`rev`) generated by trips
leaving from a specified station.

## Interpretation

**Seasonality (Month):** - The revenue seems to have a seasonal pattern.
Compared to April (reference month), May (`mm5`) sees an increase in
revenue by about 4.525. This increase is even more pronounced in the
following months, with September (`mm9`) having the most substantial
uplift of around 18.693\$.

**Temperature (`temp`):** - For every 1°C increase in temperature, the
revenue increases by approximately 0.383 \$, which is statistically
significant (p-value: 0.0085). - This suggests that warmer days tend to
generate more revenue.

**Rainfall (`rain`):** - For every additional mm of rainfall, the
revenue decreases by approximately 0.493\$, which is statistically
significant (p-value: 7.13e-06). - This implies that rainfall negatively
impacts the revenue.

**Model Fit:** - The Multiple R-squared value (0.04008) implies that
around 4% of the variation in revenue is explained by the predictors in
the model. While statistically significant (F-statistic p-value: \<
2.2e-16), the model might benefit from considering additional predictors
or non-linear effects to explain more of the variance in revenue.

## Business implications

1.  **Operational Adjustments:** Given that revenue is higher in warmer
    months, consider optimizing operations for this period. This might
    involve higher staffing, more promotional activities, or ensuring
    optimal equipment availability.

2.  **Rainy Day Strategies:** Since rainfall seems to negatively impact
    revenue, consider implementing strategies to mitigate this. For
    instance, promotional offers or special activities/events for rainy
    days might help attract customers.

## Verification of Assumptions

### Normality of residuals

```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns
seasonal_effect_rev_residual_qqplot = qqnorm(seasonal_effect_rev_model$residuals)
qqline(seasonal_effect_rev_model$residuals)
seasonal_effect_rev_residual_hist = hist(seasonal_effect_rev_model$residuals, main="Histogram of Residuals", xlab="Residuals")

```

1.  **Histogram of Residuals**: These histograms have a clear right-skew
    with a peak close to zero and a long tail towards the right. This
    suggests that most residuals are clustered around zero, but there
    are a few larger positive residuals. This is an indication that the
    normality assumption of the residuals may be violated.

2.  **Normal Q-Q Plot**: Most of the points are close to the line, which
    is a good sign. However, there's a clear deviation from the line on
    the top right corner, suggesting the presence of larger residuals
    that are not explained by a normal distribution. This reiterates the
    presence of the right skew seen in these histograms.

**Overall Interpretation**: The residuals are not perfectly normal. They
show a positive skewness, indicating there might be some observations
with higher residuals (perhaps outliers or instances where the model
systematically underpredicts). The deviation from normality might not be
a problem because the sample is large enough.

# Research Question 2: How do daily and weekly patterns impact trip durations for BIXI Montréal?

## Model

```{r Time_pattern_trip_duration, echo=FALSE}
time_pattern_dur_model <- lm(dur ~ dd + wday + holiday, data=df_main) # Should we look at the interaction term here? duration is correlated to the number of trips which explains the favourable f test. Data leakage? n_am and n_pm were removed, interpreation change need to be done
summary(time_pattern_dur_model)
```
## Interpretation

**Overall Model** - The model explains approximately 87.27% of the
variation in the trip duration. - The model is statistically significant
(F-statistic p-value is extremely small), suggesting that the predictors
in the model collectively have an effect on the trip duration.

**Intercept** - When all other variables are at their reference level
(Friday not on a holiday), the predicted trip duration is about 30.77
minutes on average.

**Coefficients** - **dd (Day of the Month)**: For each day later in the
month, the trip duration decreases by about 0.0688 minutes on average,
although this effect is not statistically significant (p = 0.58548).

-   **wday (Weekday)**: Compared to the Friday:

    -   **Monday**: Trips are shorter by about 27.97 minutes on average.
    -   **Saturday**: Trips are longer by about 29.10 minutes on
        average.
    -   **Sunday**: Trips are longer by about 11.20 minutes on average.
    -   **Thursday**: Trips are shorter by about 11.92 minutes on
        average.
    -   **Tuesday**: Trips are shorter by about 29.25 minutes on
        average.
    -   **Wednesday**: Trips are shorter by about 18.29 minutes on
        average.
    -   The coefficients for all these weekdays are statistically
        significant.

-   **Holiday**: On holidays, trips are on average longer by about 56.24
    minutes compared to non-holidays. This effect is statistically
    significant, suggesting holidays might lead to longer leisure trips
    or normal trips to different destinations than workdays.

-   **n_AM (Number of Trips in the Morning)**: For each additional trip
    in the morning, the trip duration increases by about 8.51 minutes on
    average. This is statistically significant, implying that when there
    are more trips in the morning, they tend to be longer.

-   **n_PM (Number of Trips in the Afternoon)**: For each additional
    trip in the afternoon, the trip duration increases by about 19.12
    minutes on average. This is statistically significant and implies
    that afternoon trips tend to be longer.

-   **Interaction Term (n_AM:n_PM)**: The negative coefficient (-0.0920)
    suggests that as the number of trips in both the morning and
    afternoon increases, there's a slight decrease in the overall trip
    duration. However, given the fact that the coefficient is really
    weak, the impact will be almost imperceptible.

## Business implications

1.  **Promotion and Marketing**: If the bike sharing company wants to
    run promotions, they might consider targeting days when users take
    longer trips, like Saturdays or holidays.

2.  **Resource Allocation**: Understanding that afternoon trips are
    longer might help in resource allocation, e.g., ensuring bikes are
    available and well-maintained for the afternoon surge.

3.  **Pricing Strategy**: The company can consider dynamic pricing based
    on the day of the week or if it's a holiday, adjusting prices for
    longer trip durations on certain days.

4.  **Operational Strategy**: The interaction term suggests that on
    particularly busy days (both morning and afternoon), the average
    trip duration decreases slightly. This could be due to increased
    congestion or users taking shorter trips when they notice many bikes
    are in use.

## Verification of assumptions
### Normality of residuals

```{r echo=FALSE}
par(mfrow=c(1,2))  # 1 row, 2 columns

time_pattern_dur_residual_qqplot = qqnorm(time_pattern_dur_model$residuals)
qqline(time_pattern_dur_model$residuals)
time_pattern_dur_residual_hist = hist(time_pattern_dur_model$residuals, main="Histogram of Residuals", xlab="Residuals")

```

**Histogram of Residuals**: - At first glance, the residuals appear to
be roughly normally distributed as the majority of them are centered
around zero.

**Normal Q-Q Plot**: - If the residuals were perfectly normally
distributed, the points would lie exactly on the diagonal line. - For
the most part, the points closely follow the lines, suggesting that the
residuals are approximately normally distributed. - Nevertheless,
there's a deviation from the line at both the lower and upper ends. This
implies that there are some residuals that are more extreme than what
we'd expect under a perfect normal distribution, indicating the presence
of outliers or potentially heavy tails in the residual distribution.

**Implications**:

-   The residuals being approximately centered around zero and their
    near-normal distribution suggest that the model's assumption of
    linearity and constant variance (homoscedasticity) are likely met.
    This is good for the validity of the regression analysis.

-   The presence of outliers or extreme values, as indicated by the
    tails in the histogram and the deviations in the Q-Q plot, might
    influence the regression results. These influential observations
    could distort the regression coefficients and reduce the precision
    of predictions.

-   The existence of outliers suggests that it might be beneficial to
    investigate these specific data points further to determine if
    they're genuine observations or potential errors. If they're
    genuine, one might consider robust regression techniques or
    transformations to minimize their influence.

# Research Question 3: What variables impact the average bixi trip duration?

## Variables Selection

The idea is to identify the driving factors of a bixi trip length when
we control for most of the variables.

Average trip duration for members is a good proxy for the revenue they
would bring if they were non-members.

Variables that make business sense to include:

From our seasonality analysis we identified: 
- Season (season) 
-Temperature in degrees celcius (temp) 
- Rainfall in mm (rain)

From our daily and weekly pattern analysis we identified: 
- Part of the week i.e. weekend or weekday (wknd_ind) 
- If it is a holiday (holiday)

Some other variables that are interesting: 
- If the user is a member (mem) 
- Location of the bixi station compared to Parc Lafontaine (North_South) and (West_East) 
- Proportion of trips in the morning versus the whole day (percent_AM) 
- total number of trips (n_tot)
- If the station is a metro station (Metro_ind)
- If we are at the beginning of month or the end of the month (PartOfMonth)

Interactions: In our EDA we observed a different week day usage of the
member and non members, thus an interaction term between members and day
of week would be interesting. (wday\*mem).

Note : By incorporating most of the important variables we increase our chance of respecting the assumption of E(e)=0.

Let's take a quick look at the correlation between our numerical variables to estimate the effect of collinearity.
```{r , echo=FALSE}
cor(df_main[c('avg', 'temp', 'rain', 'n_tot', 'percent_AM')])
```
We see very low correlation between the Xs which means we should not get any problems with collinearity between our numerical variables.

```{r , echo=FALSE}
plot(df_main$n_tot, df_main$avg)  
```
The variable total number of trip (n_tot) has been removed from the regression because it did not pass the assuption of constant variance, making the model not correctly specified. This makes intuitive sense since as the number of trip increases, the average trip duration should converge towards the true mean.

## Model
```{r , echo=FALSE}
model_AvgDur <- lm(avg ~ season + temp + rain + wknd_ind*mem + holiday  + North_South + West_East + percent_AM + PartOfMonth + Metro_ind, data = df_main)
summary(model_AvgDur)
```

Let's use the variance inflation factor to verify for collinearity, we will use a standard threshold of 5.
```{r , echo=FALSE}
vif(model_AvgDur)
```
No major problem is detected, since the global vifs are all relatively low.

## Interpretation

**Overall Model** - The model explains approximately 12.52% of the
variation in the average trip duration. which means that other factors
are also at play and not included in the model.

**Intercept** - The interpretation of the intercept does not make sense
in this case since the number of trips would have to be zero.

**Coefficients** - **Season**: The reference level is fall. We can see
that on average trip duration during spring and summer are respectively
2.33 and 0.38 minutes longer than in fall holding everything else
constant.

-   **Temperature**: The coefficient of temperature is 0.14 which means
    that an increase in temperature of 1 degree celcius corresponds to
    an increase of average trip duration of 0.14 minutes on average
    holding all else constant.

-   **Rainfall**: The coefficient for rain is -0.12 which means that an
    increase in rainfall of 1 mm corresponds to a decrease of average
    trip duration of 0.12 minutes on average holding all else constant.

-   **Effect of Weekend Indicator and membership**: Since there exists
    an interaction between both variables, it is no longer possible to
    interpret one without the other. This implies that the relation
    between average trip duration and membership is different depending
    on the moment of the week. The opposite is also true, the relation
    between average trip duration and the moment of the week is
    different depending on the membership status.

-   Weekend indicator's coefficient 2.638923 is the average difference
    between average trip duration during weekend and weekday for
    non-members. In other words, for non-members, average trip duration
    is higher on average than for members holding all else constant.

-   Membership's coefficient -0.385385 is the average difference between
    average trip duration for members and non-members for weekdays. In
    other words, during weekdays, the average trip duration is shorter
    on average for members than for non-members holding all else
    constant.

-   Interaction term's coefficient -1.868383 is ...

-   **Holiday**: The coefficient for holiday is 1.069557 which means
    that during holidays average trip duration is 1.069 minutes higher
    on average than during non-holidays, holding all else constant.

-   **North_South and West_East**: Their coefficients are 0.35 and -0.23
    which means that on average the average trip duration for trips
    starting at a station South of Parc Lafontaine or West is 0.35 and
    -0.23 minutes different from their counter parts respectively,
    holding all else constant.

-   **Total number of trips**: The coefficient is -0.055315 which means
    that on average as number of trips increase, the average trip length
    in minutes decreases, holding all else constant.

-   **Percent AM**: The magnitude of the coefficient -2.351044 is less
    important than its sign for our interpretation. What it means is
    that as the proportion of trips in the morning increases, the
    average trip duration generally decreases when holding all else
    constant. This hints that trips in the morning might be shorter on
    average than trip in the afternoon, hence bring in less revenue.

## Business Implications:

1.  **Promotion and Marketing**: For the same temperature, average trip
    length tends to be the longest in spring. This indicates that users
    are eager to use bikes after winter. This insight could be used for
    promotion purposes.

2.  **Resource Allocation**: Expect longer trips when it is hot and
    non-rainy outside. Even more if it is a weekend or holiday. Also,
    bikes tend to be borrowed longer during the afternoon than in the
    morning. Stations south of Parc Lafontaine have on average longer
    trip duration, which may suggests that stations are further from one
    another. There might be some space for additional stations.

3.  **Pricing Strategy**: The usage that is associated with the longest
    trip length based on our interaction term is for non-members during
    the weekend. Charging a heftier price for these people at that time
    may increase profit margins significantly.

4.  **Operational Strategy**: It is important to keep in mind the
    tradeoff between the number of trips and the average trip length.
    Indeed, as the number of trips increase for a given day, the average
    trip length decreases. This may suggest that the additional trips
    during those days are short haul.
    
## Verification of assumptions

### Verification of Normality of Residuals

```{r, echo=FALSE}
res = hist(model_AvgDur$residuals, main="Histogram of Residuals", xlab="Residuals")

```

### Verificaiton of Heteroscedasticity

```{r , echo=FALSE}
residuals_df <- data.frame(df_main, residuals = residuals(model_AvgDur))

p1 <- ggplot(data = residuals_df, aes(x = temp, y = residuals)) +
  geom_point() +
  labs(x = "temp", y = "Residuals")

p2 <- ggplot(data = residuals_df, aes(x = rain, y = residuals)) +
  geom_point() +
  labs(x = "rain", y = "Residuals")

p3 <- ggplot(data = residuals_df, aes(x = lntot, y = residuals)) +
  geom_point() +
  labs(x = "lntot", y = "Residuals")

p4 <- ggplot(data = residuals_df, aes(x = percent_AM, y = residuals)) +
  geom_point() +
  labs(x = "percent_AM", y = "Residuals")

grid.arrange(p1, p2, p4, ncol=2)

```
season, wknd_ind, mem, holiday, North_South, West_East, PartOfMonth, Metro_ind

```{r , echo=FALSE}
p5 <- ggplot(data = residuals_df, aes(x = season, y = residuals)) + geom_boxplot() +
  labs(x = "season", y = "Residuals")

p6 <- ggplot(data = residuals_df, aes(x = mem, y = residuals)) + geom_boxplot() +
  labs(x = "mem", y = "Residuals")

p7 <- ggplot(data = residuals_df, aes(x = holiday, y = residuals)) + geom_boxplot() +
  labs(x = "holiday", y = "Residuals")

p8 <- ggplot(data = residuals_df, aes(x = North_South, y = residuals)) + geom_boxplot() +
  labs(x = "North_South", y = "Residuals")

p9 <- ggplot(data = residuals_df, aes(x = West_East, y = residuals)) + geom_boxplot() +
  labs(x = "West_East", y = "Residuals")

p10 <- ggplot(data = residuals_df, aes(x = PartOfMonth, y = residuals)) + geom_boxplot() + labs(x = "PartOfMonth", y = "Residuals")

p11 <- ggplot(data = residuals_df, aes(x = Metro_ind, y = residuals)) + geom_boxplot() + labs(x = "Metro_ind", y = "Residuals")

grid.arrange(p5, p6, p7, p8, p9, p10, p11, ncol=3)

```
## Model correctly specified
```{r , echo=FALSE}
plot(predict(model_AvgDur), resid(model_AvgDur)) 
```
  
# Exploratory Regression
(I would only keep the ones that bring new information and that answer business question)
## AM/PM Delta
```{r}
model <- lm(n_AM_PM_delta ~ long_wknd_ind + season + rain_ind + mem, data = df_main) # Goal is to look at stations more used in the mornings than afternoons
summary(model)
```

## Trip length wkday/wknd
```{r}
#df_main 
# SHORTER TRIPS ON WEEKDAYS THAN WEEKENDS
model <- lm(avg ~ long_wknd_ind + season + rain_ind + mem, data = df_main)
summary(model)
```

## trip length for members/non-members
```{r}
# MEMBERS TAKE SHORTER TRIPS
# MEMBERS TAKE LONGER TRIPS IN THE RAIN
model <- lm(avg ~ (rain_ind *mem) + long_wknd_ind, data = df_main)
summary(model)
```

## Revenue per trip: seasonal effect
```{r}
#HIGHER REVENUE PER TRIP IN SPRING AND SUMMER THAN WINTER
model <- lm(rev_per_trip ~ long_wknd_ind + season + rain_ind, data = df_main)
summary(model)
```

## Number of trips as season advances
```{r}
#df_main 
# AS BIXI SEASON GOES ON, WEEKDAY NUMBER OF TRIPS GO UP WITH A STATISTICAL SIGNIFICANCE
model <- lm(n_tot ~ (long_wknd_ind*week_num), data = df_main)
summary(model)
```

```{r}
plot(model,4)
```

```{r}
plot(model,5)
```


# Limitations and shortcomings

-   Causation vs. Correlation: The regression model captures
    relationships but does not establish causation.
-   Data Exclusions: The data only considers trips under 60 minutes,
    which might exclude a segment of users who use BIXI for longer
    journeys.
-   Other External Factors: Events, road conditions, or public
    transportation disruptions can affect BIXI usage but are not
    captured in the dataset.
-   Mention Auto-correlation (Chike)

# Conclusion
(Review the research questions that were answered)

# Contribution

Charles Julien :

Gabriel Jobert :

Chike Odenigbo:

Atul Sharma: